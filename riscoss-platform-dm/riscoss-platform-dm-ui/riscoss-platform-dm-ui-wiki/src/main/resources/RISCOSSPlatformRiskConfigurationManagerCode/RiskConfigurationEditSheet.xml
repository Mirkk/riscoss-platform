<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc>
  <web>RISCOSSPlatformRiskConfigurationManagerCode</web>
  <name>RiskConfigurationEditSheet</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>RISCOSSPlatformRiskConfigurationManagerCode.RiskConfigurationClass</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1396991284000</creationDate>
  <date>1397911910000</date>
  <contentUpdateDate>1397911910000</contentUpdateDate>
  <version>1.1</version>
  <title>#if($doc.name == 'RiskConfigurationSheet')RiskConfiguration Sheet#{else}$services.display.title($doc, {'displayerHint': 'default'})#end</title>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>false</hidden>
  <object>
    <class>
      <name>XWiki.JavaScriptExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage=Always on this page|onDemand=On demand|always=Always on this wiki</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <name>RISCOSSPlatformRiskConfigurationManagerCode.RiskConfigurationEditSheet</name>
    <number>0</number>
    <className>XWiki.JavaScriptExtension</className>
    <guid>eaa1362f-f1fd-4912-9a06-f1996f1fc0b8</guid>
    <property>
      <cache>forbid</cache>
    </property>
    <property>
      <code>var XWiki = (function(XWiki) {
  var bindFileUploader = function(input, responseContainer) {
    new XWiki.FileUploader(input, {
      autoUpload: true,
      progressAutohide: true,
      targetURL: $('uploadTargetURL').value, //We use this because if we do $doc.getURL here we get the URL of the sheet. So the upload URL must be generated in the parsed sheet content and passed to this script.
      responseURL: XWiki.currentDocument.getURL('get', 'xpage=attachmentslist'),
      responseContainer: responseContainer
    });
  }
  
  function init() {
    var fileInputs = $$('input[type="file"]');
    for(i = 0; i &lt; fileInputs.length; i++) {      
      bindFileUploader(fileInputs[i], $('invisiblediv'));
    }
    
    document.observe('xwiki:html5upload:message', function(e) {
      if("UPLOAD_FINISHED" == e.memo.content) {        
        $(e.srcElement.id + ':text').update(e.memo.parameters.name);
        $(e.srcElement.id + ':value').value = e.memo.parameters.name;
      }
    });        
  }
  
  //Wait for dom load
  (XWiki.domIsLoaded &amp;&amp; init()) || document.observe('xwiki:dom:loaded', init);
  
  //End XWiki augmentation
  return XWiki;
} (XWiki || {}))

</code>
    </property>
    <property>
      <name/>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.SheetDescriptorClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <action>
        <customDisplay/>
        <disabled>0</disabled>
        <name>action</name>
        <number>1</number>
        <picker>0</picker>
        <prettyName>Action</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </action>
    </class>
    <name>RISCOSSPlatformRiskConfigurationManagerCode.RiskConfigurationEditSheet</name>
    <number>0</number>
    <className>XWiki.SheetDescriptorClass</className>
    <guid>890d9974-6453-45b6-8cf8-f391b1cb0f9b</guid>
    <property>
      <action>edit</action>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.XWikiComments</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <author>
        <disabled>0</disabled>
        <name>author</name>
        <number>1</number>
        <prettyName>Author</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </author>
      <comment>
        <disabled>0</disabled>
        <name>comment</name>
        <number>5</number>
        <prettyName>Comment</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </comment>
      <date>
        <dateFormat>dd/MM/yyyy HH:mm:ss</dateFormat>
        <disabled>0</disabled>
        <emptyIsToday>1</emptyIsToday>
        <name>date</name>
        <number>4</number>
        <picker>1</picker>
        <prettyName>Date</prettyName>
        <size>20</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.DateClass</classType>
      </date>
      <highlight>
        <disabled>0</disabled>
        <name>highlight</name>
        <number>2</number>
        <prettyName>Highlighted Text</prettyName>
        <rows>2</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </highlight>
      <originalSelection>
        <disabled>0</disabled>
        <name>originalSelection</name>
        <number>9</number>
        <prettyName>Original Selection</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </originalSelection>
      <replyto>
        <disabled>0</disabled>
        <name>replyto</name>
        <number>3</number>
        <numberType>integer</numberType>
        <prettyName>Reply To</prettyName>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.NumberClass</classType>
      </replyto>
      <selection>
        <disabled>0</disabled>
        <name>selection</name>
        <number>6</number>
        <prettyName>Selection</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </selection>
      <selectionLeftContext>
        <disabled>0</disabled>
        <name>selectionLeftContext</name>
        <number>7</number>
        <prettyName>Selection Left Context</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </selectionLeftContext>
      <selectionRightContext>
        <disabled>0</disabled>
        <name>selectionRightContext</name>
        <number>8</number>
        <prettyName>Selection Right Context</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </selectionRightContext>
      <state>
        <disabled>0</disabled>
        <name>state</name>
        <number>11</number>
        <prettyName>State</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </state>
      <target>
        <disabled>0</disabled>
        <name>target</name>
        <number>10</number>
        <prettyName>Target</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </target>
    </class>
    <name>RISCOSSPlatformRiskConfigurationManagerCode.RiskConfigurationEditSheet</name>
    <number>0</number>
    <className>XWiki.XWikiComments</className>
    <guid>281dd8a9-6e4a-4463-a761-57207c3edad1</guid>
    <property>
      <author>XWiki.Admin</author>
    </property>
    <property>
      <comment>This sheet is pretty complex. Here it is a description of how it works:

1. For every layer we generate a box that contains all the relevant artifact that can be associated to a layer. These are basically the fields defined in the RISCOSSPlatformRiskConfigurationManagerCode.LayerRiskConfigurationClass (i.e., riskModel, impactModel, and whatever will be needed for the analysis)
1. The box will contain the following elements, each one identified by an id:
11. A file upload input type. Its id can be arbitrary but we chose to use "artifact:layer" (e.g., "riskModel:OSS Component")
11. A span where the name of the uploaded artifact will be displayed. Its id is in the form: "artifact:layer:text" where "artifact:layer" is the same used for 2.1
11. A hidden input that will be used to save the uploaded artifact name to the appropriate object. Its id is in the form "artifact:layer:value". The input uses the XWiki object notation in order to identify the object where to store the information
11. A hidden input that defines the value of the layer property of the target object where to store the information.

Outside the box there are the following elements defined:

1. A hidden input whose id is "uploadTargetURL" that is used to communicate to the JavaScript script where to upload the files. We need to put this here because if we put $doc.getURL('upload') in the JavaScript we end up with the URL of the sheet, instead of that of the document
1. A hidden input for enabling the updateOrCreate object policy
1. An invisible div which is used to make the html5uploader not to display anything after the upload is finished

----

How it works:

1. The script iterates on every layer
1. For each layer the box is generated. This box basic contains all the information for filling the fields of RISCOSSPlatformRiskConfigurationManagerCode.LayerRiskConfigurationClass
1. The JavaScript is initialized and all the file inputs are bound to the html5uploader
1. The id of the different inputs/span are used to link things together. So when an upload triggered by an input whose id is "X" finishes, then the name of the uploaded file will be set in all the linked entities (i.e., the span and the hidden input)
1. When everything is completed and the user saves the document then a RISCOSSPlatformRiskConfigurationManagerCode.LayerRiskConfigurationClass object for every layer is created with the proper information stored in the corresponding fields (thanks to the object policy updateOrCreate)
</comment>
    </property>
    <property>
      <date>2014-04-18 23:05:46.0</date>
    </property>
    <property>
      <highlight/>
    </property>
    <property>
      <originalSelection/>
    </property>
    <property>
      <replyto/>
    </property>
    <property>
      <selection/>
    </property>
    <property>
      <selectionLeftContext/>
    </property>
    <property>
      <selectionRightContext/>
    </property>
    <property>
      <state/>
    </property>
    <property>
      <target/>
    </property>
  </object>
  <content>{{velocity}}
$xwiki.jsfx.use('uicomponents/widgets/upload.js', true)
$xwiki.ssfx.use('uicomponents/widgets/upload.css', true)
$xwiki.jsx.use('RISCOSSPlatformRiskConfigurationManagerCode.RiskConfigurationEditSheet')

#set($layers = $services.query.xwql("select doc.fullName, doc.title from Document doc, doc.object(RISCOSSPlatformLayerManagerCode.LayerClass) as layer where doc.space='RISCOSSPlatformLayers'").execute())

#set($object = $doc.getObject('RISCOSSPlatformRiskConfigurationManagerCode.RiskConfigurationClass'))
#set($class = $object.xWikiClass)
#foreach($prop in $class.properties)
; $prop.prettyName  
: $doc.display($prop.getName())
#end

#set($i = 0)
#foreach($layer in $layers)
  #set($layerRiskConfiguration = $doc.getObject("RISCOSSPlatformRiskConfigurationManagerCode.LayerRiskConfigurationClass", "layer", $layer[0]))

{{box title="== Models for layer '$layer[1]'"}}

{{html wiki="true"}}
&lt;input type="hidden" name="RISCOSSPlatformRiskConfigurationManagerCode.LayerRiskConfigurationClass_${i}_layer" value="$layer[0]"/&gt;

; **Risk model:**
: &lt;span id="riskModel:${layer[1]}:text"&gt;$!layerRiskConfiguration.getProperty("riskModel").value&lt;/span&gt;&lt;input id="riskModel:${layer[1]}:value" type="hidden" name="RISCOSSPlatformRiskConfigurationManagerCode.LayerRiskConfigurationClass_${i}_riskModel" value="$!layerRiskConfiguration.getProperty("riskModel").value"/&gt;&lt;input type="file" name="filepath" id="riskModel:${layer[1]}" /&gt;

; **Impact model:**
: &lt;span id="impactModel:${layer[1]}:text"&gt;$!layerRiskConfiguration.getProperty("impactModel").value&lt;/span&gt;&lt;input id="impactModel:${layer[1]}:value" type="hidden" name="RISCOSSPlatformRiskConfigurationManagerCode.LayerRiskConfigurationClass_${i}_impactModel" value="$!layerRiskConfiguration.getProperty("impactModel").value"/&gt;&lt;input type="file" name="filepath" id="impactModel:${layer[1]}" /&gt;

{{/html}}

{{/box}}

  #set($i = $i + 1)
#end

{{html}}
&lt;input id="uploadTargetURL" type="hidden" name="uploadTargetURL" value="$doc.getURL('upload')"/&gt;
&lt;input type="hidden" name="objectPolicy" value="updateOrCreate"/&gt;
&lt;div id="invisiblediv" style="display:none"&gt;&lt;/div&gt; 
{{/html}}

{{/velocity}}
</content>
</xwikidoc>
